<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Atendimento</title>
    <link rel="stylesheet" href="../templates/novo_atendimento.css">
    <link rel="shortcut icon" href="../imagens/ico.ico" type="image/x-icon">
</head>
<body>
    <div class="dashboard-container">
        <div class="header-medico">
            <h2>Novo Atendimento</h2>
            <a href="dashbord_medico.html" class="cancelar">Cancelar e Voltar</a>
        </div>

        <div class="content">
            <h3>Registro de Atendimento</h3>
            <hr>

            <label for="busca-paciente">Buscar Paciente (CPF):</label>
            <div class="busca-container">
                <input type="text" id="busca-paciente" placeholder="Digite o CPF do paciente...">
                <button id="btn-buscar">Buscar</button>
            </div>
            <p id="status-busca" class="status"></p>
            <div id="historico-paciente-container" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #17a2b8;">
    <h4 style="margin-top: 0; color: #17a2b8;">üìú √öltimos Atendimentos:</h4>
    <ul id="lista-historico-resumido" style="padding-left: 20px; color: #555; font-size: 14px;"></ul>
</div>

            <label for="obs-atendimento">Observa√ß√µes da Consulta:</label>
            <textarea id="obs-atendimento" rows="5"></textarea>

            <h3>Solicitar Exames</h3>
            <div id="lista-exames-disponiveis" class="lista-exames">
                <p>Carregando exames...</p>
            </div>

            <hr>
            <button class="btn-submit" id="salvar-atendimento">Salvar Atendimento e Exames</button>
        </div>
    </div>

    <script src="../templates/config.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- 1. Sele√ß√£o dos Elementos ---
            const btnBuscar = document.getElementById("btn-buscar");
            const inputBusca = document.getElementById("busca-paciente");
            const statusBusca = document.getElementById("status-busca");
            const btnSalvar = document.getElementById("salvar-atendimento");
            
            const divListaExames = document.getElementById('lista-exames-disponiveis');
            
            let pacienteEncontrado = null; // Armazena o objeto COMPLETO do paciente
            let medicoId = localStorage.getItem('medico_id'); // Pega o ID do m√©dico logado

// --- 2. Carregar Exames Dispon√≠veis (da API) ---
            fetch(API_URL + '/api/exames')
                .then(response => response.json())
                .then(data => {
                    divListaExames.innerHTML = ''; // Limpa "Carregando..."
                    
                    if (data.length === 0) {
                        divListaExames.innerHTML = '<p>Nenhum exame cadastrado.</p>';
                        return;
                    }

                    data.forEach(exame => {
                        // CORRE√á√ÉO AQUI:
                        // Garantimos que o pre√ßo seja um n√∫mero. Se vier nulo, usa 0.
                        const preco = parseFloat(exame.preco_padrao || 0);

                        const label = document.createElement('label');
                        label.innerHTML = `
                            <input type="checkbox" data-id-exame="${exame.id_exame}" data-preco-padrao="${preco}"> 
                            ${exame.nome || exame.descricao} 
                            <span class="preco-exame"> (Padr√£o: R$ ${preco.toFixed(2)})</span>
                        `;
                        divListaExames.appendChild(label);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar exames:', error);
                    divListaExames.innerHTML = '<p style="color: red;">Erro ao carregar exames.</p>';
                });
            // --- 4. L√≥gica de Busca de Paciente (com API) ---
            btnBuscar.addEventListener("click", () => {
                const termo = inputBusca.value.trim(); // CPF
                if (!termo) {
                    statusBusca.textContent = "Digite o CPF do paciente.";
                    statusBusca.className = "status erro";
                    pacienteEncontrado = null;
                    return;
                }

                statusBusca.textContent = "Buscando...";
                statusBusca.className = "status";
                
                fetch(API_URL + '/api/pacientes/cpf/' + termo)
                    .then(response => {
                        if (!response.ok) throw new Error('Paciente n√£o encontrado');
                        return response.json();
                    })
                    .then(paciente => {
    pacienteEncontrado = paciente; 
    statusBusca.textContent = `Paciente encontrado: ${paciente.nome}`;
    statusBusca.className = "status ok";

    // --- NOVO C√ìDIGO: Buscar Hist√≥rico ---
    const divHistorico = document.getElementById('historico-paciente-container');
    const listaHistorico = document.getElementById('lista-historico-resumido');
    
    fetch(`${API_URL}/api/pacientes/${paciente.id_paciente}/historico_resumido`)
        .then(res => res.json())
        .then(historico => {
            listaHistorico.innerHTML = ''; // Limpa anterior
            
            if (historico.length > 0) {
                divHistorico.style.display = 'block'; // Mostra a caixa
                historico.forEach(item => {
                    const data = new Date(item.data_atendimento).toLocaleDateString('pt-BR');
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${data}</strong> (${item.Especialidade}): ${item.observacoes}`;
                    listaHistorico.appendChild(li);
                });
            } else {
                divHistorico.style.display = 'none'; // Esconde se n√£o tiver nada
            }
        });

                    })
                    .catch(error => {
                        pacienteEncontrado = null;
                        statusBusca.textContent = "Paciente n√£o encontrado.";
                        statusBusca.className = "status erro";
                    });
            });

            // --- 5. L√≥gica de Salvar Atendimento (com API) ---
            btnSalvar.addEventListener("click", async () => {
                const observacoes = document.getElementById("obs-atendimento").value.trim();
                
                if (!pacienteEncontrado) {
                    alert("Selecione um paciente v√°lido antes de salvar o atendimento.");
                    return;
                }
                if (!medicoId) {
                    alert("Erro: M√©dico n√£o identificado. Fa√ßa login novamente.");
                    return;
                }

                try {
                    // --- 5a. Salva o Atendimento (Consulta) ---
                    const dadosAtendimento = {
                        id_paciente: pacienteEncontrado.id_paciente,
                        id_medico: parseInt(medicoId),
                        data_atendimento: new Date().toISOString(), // Data/hora atual
                        observacoes: observacoes
                    };

                    const responseAtendimento = await fetch(API_URL + '/api/atendimentos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dadosAtendimento)
                    });

                    if (!responseAtendimento.ok) {
                        const erro = await responseAtendimento.json();
                        throw new Error('Falha ao salvar atendimento: ' + erro.message);
                    }

                    // --- 5b. Salva os Exames Solicitados ---
                    const examesSelecionados = document.querySelectorAll("#lista-exames-disponiveis input:checked");
                    if (examesSelecionados.length > 0) {
                        const promessasExames = [];
                        examesSelecionados.forEach(checkbox => {
                            const dadosExame = {
                                id_paciente: pacienteEncontrado.id_paciente,
                                id_exame: parseInt(checkbox.dataset.idExame),
                                data_realizacao: new Date().toISOString()
                            };
                            
                            const promessa = fetch(API_URL + '/api/exames_realizados', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(dadosExame)
                            });
                            promessasExames.push(promessa);
                        });
                        await Promise.all(promessasExames); // Espera todos salvarem
                    }

                    alert(`Atendimento e exames salvos com sucesso para o paciente ${pacienteEncontrado.nome}.`);
                    window.location.href = "dashbord_medico.html";

                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    alert("Erro ao salvar: " + error.message);
                }
            });
        });
    </script>
</body>
</html>
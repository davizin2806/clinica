<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Médico</title>
    <link rel="stylesheet" href="../templetes/medico.css">
    <link rel="shortcut icon" href="../imagens/ico.ico" type="image/x-icon">
</head>
<body>
    <div class="dashboard-container">
        <div class="header-medico">
            <img src="../imagens/clinica.png" alt="Logo da Clínica" class="header-logo">
            <h2>Área do Médico</h2> 
            <button class="logout-button">Sair</button>
        </div>        
        <div class="content">
            <h3>Bem-vindo, Dr(a). <span id="nomeMedico">[Carregando...]</span></h3>
            <hr>
            <section class="dashboard-section acoes-rapidas">
                <button id="btn-novo-atendimento" class="submit">Novo Atendimento</button>
                <button id="btn-cadastrar-paciente" class="submit">
                Cadastrar Novo Paciente
                </button>
                <button id="btn-historico-medico" class="submit" style="background-image: linear-gradient(to right, #6c757d, #5a6268);">
                    Ver Histórico Completo
                </button>
            </section>
            <section class="dashboard-section">
                <h2>Resumo de Atendimentos (por Médico)</h2>
                <div id="lista-atendimentos-medico">
                    <p>Carregando resumo...</p>
                </div>
            </section>
            <section class="dashboard-section">
                <h2>Meus Pacientes</h2>
                <input type="text" id="filtroPacientes" placeholder="Buscar paciente por nome ou CPF...">
                <div id="lista-pacientes">
                    <p>Carregando pacientes...</p>
                </div>
            </section>                 
        </div>
    </div>
    
    <script src="../templetes/dashboard_medico.js"></script>

    <script>
        const API_URL = 'http://172.20.12.151:5000'; // ⚠️ MUDE SE O IP MUDAR
        let todosPacientes = []; // Cache para o filtro

        document.addEventListener('DOMContentLoaded', function() {
            
            const medicoNome = localStorage.getItem('usuario_nome');
            if(medicoNome) {
                document.getElementById('nomeMedico').textContent = medicoNome;
            } else {
                 document.getElementById('nomeMedico').textContent = 'Doutor(a)';
            }
            
            // --- 1. Carregar Resumo de Atendimentos ---
            const containerAgenda = document.getElementById('lista-atendimentos-medico');
            fetch(API_URL + '/api/relatorios/atendimentos_medico')
                .then(response => response.json())
                .then(data => {
                    containerAgenda.innerHTML = '';
                    if (data.length === 0) {
                        containerAgenda.innerHTML = '<p>Nenhum atendimento registrado no sistema.</p>';
                        return;
                    }
                    data.forEach(atendimento => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <strong>Médico:</strong> ${atendimento.NomeMedico}<br>
                            <strong>Especialidade:</strong> ${atendimento.Especialidade}<br>
                            <strong>Total de Atendimentos:</strong> ${atendimento.TotalAtendimentos}
                        `;
                        containerAgenda.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar agenda:', error);
                    containerAgenda.innerHTML = '<p>Erro ao carregar agenda.</p>';
                });

            // --- 2. Carregar Lista de Pacientes ---
            const containerPacientes = document.getElementById('lista-pacientes');
            fetch(API_URL + '/api/pacientes')
                .then(response => response.json())
                .then(data => {
                    todosPacientes = data; // Salva no cache
                    renderPacientes(data); // Exibe todos
                })
                .catch(error => {
                    console.error('Erro ao carregar pacientes:', error);
                    containerPacientes.innerHTML = '<p>Erro ao carregar pacientes.</p>';
                });

            // --- 3. Lógica do Filtro de Pacientes ---
            document.getElementById('filtroPacientes').addEventListener('input', function(e) {
                const termo = e.target.value.toLowerCase();
                if (!termo) {
                    renderPacientes(todosPacientes);
                    return;
                }
                const pacientesFiltrados = todosPacientes.filter(p => 
                    p.nome.toLowerCase().includes(termo) ||
                    p.cpf.includes(termo)
                );
                renderPacientes(pacientesFiltrados);
            });
        });

        function renderPacientes(pacientes) {
            const containerPacientes = document.getElementById('lista-pacientes');
            containerPacientes.innerHTML = '';
            if (pacientes.length === 0) {
                containerPacientes.innerHTML = '<p>Nenhum paciente encontrado.</p>';
                return;
            }
            pacientes.forEach(paciente => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <strong>Nome:</strong> ${paciente.nome}<br>
                    <strong>CPF:</strong> ${paciente.cpf}
                `;
                containerPacientes.appendChild(card);
            });
        }
    </script>
</body>
</html>